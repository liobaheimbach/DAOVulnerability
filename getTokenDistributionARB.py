#import libaries
import pandas as pd
import numpy as np
from web3 import Web3, HTTPProvider
import json 
from enum import Enum
import numpy as np

#url of Arbitrum node
urlARB= ""
#connect to Arbitrum client 
w3 = Web3(HTTPProvider(urlARB))

class BlockNumberARB(Enum):
    Mar31 =  196288427

def getDataFromNodeHolder(holders,w3,directory,token,address): 
    abi = json.load(open('abi/ERC20.abi'))
    contract = w3.eth.contract(address=address, abi=abi)
    tokenDistribution={}       
    decimals = contract.functions.decimals().call()
    for holder in holders:
        holder0 = "0x"+ holder[3:]
        data = contract.functions.balanceOf(w3.to_checksum_address(holder0)).call({}, int(BlockNumberARB.Mar31.value))
        tokenDistribution[holder0] = data
    tokenDistributionDF = pd.DataFrame(tokenDistribution.items(), columns=['holder', 'balance'])
    tokenDistributionDF['balance'] = tokenDistributionDF['balance'].apply(lambda x: x/(10**decimals))
    tokenDistributionDF = tokenDistributionDF[tokenDistributionDF['balance']>0]
    tokenDistributionDF.to_pickle(directory+token.lower()+'.pkl')

directory ="data/tokenDist/" 
holderstemp= pd.read_csv("data/holders/arb.csv",names=['holder'])
holders = holderstemp['holder'].values.tolist()
getDataFromNodeHolder(holders,w3,directory,'ARB','0x912CE59144191C1204E64559FE8253a0e49E6548')
